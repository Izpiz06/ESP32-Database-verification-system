<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 ID Card Verification System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: #f0f0f0;
            color: #666;
            font-size: 16px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .camera-section {
            margin-bottom: 20px;
        }

        .camera-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: block;
        }

        video, canvas {
            width: 100%;
            border-radius: 10px;
            margin-bottom: 10px;
            display: none;
            background: #000;
        }

        video.active, canvas.active {
            display: block;
        }

        .captured-image {
            width: 100%;
            border-radius: 10px;
            margin-bottom: 10px;
            display: none;
        }

        .captured-image.active {
            display: block;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .user-data {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .user-data.active {
            display: block;
        }

        .user-data h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .user-field {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .user-field:last-child {
            border-bottom: none;
        }

        .user-field strong {
            color: #666;
            display: inline-block;
            width: 150px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ ID Card Verification</h1>
        <p class="subtitle">SRM Institute Student Verification System</p>

        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('login')">Login</button>
            <button class="tab-btn" onclick="switchTab('register')">Register New User</button>
        </div>

        <!-- Login Tab -->
        <div id="login-tab" class="tab-content active">
            <div class="message" id="login-message"></div>
            
            <div class="camera-section">
                <label class="camera-label">Scan Front Side of ID Card</label>
                <video id="login-video" autoplay></video>
                <canvas id="login-canvas"></canvas>
                <img id="login-preview" class="captured-image">
            </div>

            <button class="btn btn-primary" onclick="startCamera('login')">Start Camera</button>
            <button class="btn btn-success" onclick="captureImage('login')" style="display:none;" id="login-capture-btn">Capture Image</button>
            <button class="btn btn-secondary" onclick="retakeImage('login')" style="display:none;" id="login-retake-btn">Retake</button>
            <button class="btn btn-primary" onclick="loginUser()" style="display:none;" id="login-submit-btn">Login</button>

            <div class="loading" id="login-loading">
                <div class="spinner"></div>
                <p>Processing ID card...</p>
            </div>

            <div class="user-data" id="login-user-data"></div>
        </div>

        <!-- Register Tab -->
        <div id="register-tab" class="tab-content">
            <div class="message" id="register-message"></div>
            
            <!-- Front Side Camera -->
            <div class="camera-section">
                <label class="camera-label">Step 1: Scan Front Side of ID Card</label>
                <video id="register-front-video" autoplay></video>
                <canvas id="register-front-canvas"></canvas>
                <img id="register-front-preview" class="captured-image">
            </div>

            <button class="btn btn-primary" onclick="startCamera('register-front')" id="register-front-start-btn">Start Camera (Front)</button>
            <button class="btn btn-success" onclick="captureImage('register-front')" style="display:none;" id="register-front-capture-btn">Capture Front</button>
            <button class="btn btn-secondary" onclick="retakeImage('register-front')" style="display:none;" id="register-front-retake-btn">Retake Front</button>

            <!-- Back Side Camera -->
            <div class="camera-section" id="register-back-section" style="display:none;">
                <label class="camera-label">Step 2: Scan Back Side of ID Card</label>
                <video id="register-back-video" autoplay></video>
                <canvas id="register-back-canvas"></canvas>
                <img id="register-back-preview" class="captured-image">
            </div>

            <button class="btn btn-primary" onclick="startCamera('register-back')" style="display:none;" id="register-back-start-btn">Start Camera (Back)</button>
            <button class="btn btn-success" onclick="captureImage('register-back')" style="display:none;" id="register-back-capture-btn">Capture Back</button>
            <button class="btn btn-secondary" onclick="retakeImage('register-back')" style="display:none;" id="register-back-retake-btn">Retake Back</button>

            <button class="btn btn-primary" onclick="registerUser()" style="display:none;" id="register-submit-btn">Register User</button>

            <div class="loading" id="register-loading">
                <div class="spinner"></div>
                <p>Processing ID card registration...</p>
            </div>

            <div class="user-data" id="register-user-data"></div>
        </div>
    </div>

    <script>
        let streams = {};
        let capturedImages = {};

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
                document.getElementById('login-tab').classList.add('active');
            } else {
                document.querySelector('.tab-btn:last-child').classList.add('active');
                document.getElementById('register-tab').classList.add('active');
            }

            // Stop all camera streams when switching tabs
            Object.values(streams).forEach(stream => {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
            });
            streams = {};
        }

        async function startCamera(type) {
            try {
                const video = document.getElementById(`${type}-video`);
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                video.srcObject = stream;
                video.classList.add('active');
                streams[type] = stream;

                document.getElementById(`${type}-start-btn`).style.display = 'none';
                document.getElementById(`${type}-capture-btn`).style.display = 'block';
            } catch (error) {
                alert('Error accessing camera: ' + error.message);
            }
        }

        function captureImage(type) {
            const video = document.getElementById(`${type}-video`);
            const canvas = document.getElementById(`${type}-canvas`);
            const preview = document.getElementById(`${type}-preview`);
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);

            const imageData = canvas.toDataURL('image/jpeg');
            preview.src = imageData;
            preview.classList.add('active');

            video.classList.remove('active');
            if (streams[type]) {
                streams[type].getTracks().forEach(track => track.stop());
            }

            capturedImages[type] = dataURLtoBlob(imageData);

            document.getElementById(`${type}-capture-btn`).style.display = 'none';
            document.getElementById(`${type}-retake-btn`).style.display = 'block';

            // Handle next steps based on type
            if (type === 'login') {
                document.getElementById('login-submit-btn').style.display = 'block';
            } else if (type === 'register-front') {
                document.getElementById('register-back-section').style.display = 'block';
                document.getElementById('register-back-start-btn').style.display = 'block';
            } else if (type === 'register-back') {
                document.getElementById('register-submit-btn').style.display = 'block';
            }
        }

        function retakeImage(type) {
            const video = document.getElementById(`${type}-video`);
            const preview = document.getElementById(`${type}-preview`);

            preview.classList.remove('active');
            delete capturedImages[type];

            document.getElementById(`${type}-retake-btn`).style.display = 'none';
            document.getElementById(`${type}-start-btn`).style.display = 'block';

            if (type === 'login') {
                document.getElementById('login-submit-btn').style.display = 'none';
            } else if (type === 'register-front') {
                document.getElementById('register-back-section').style.display = 'none';
                document.getElementById('register-back-start-btn').style.display = 'none';
            } else if (type === 'register-back') {
                document.getElementById('register-submit-btn').style.display = 'none';
            }
        }

        async function loginUser() {
            if (!capturedImages['login']) {
                showMessage('login', 'Please capture ID card image first', 'error');
                return;
            }

            document.getElementById('login-loading').classList.add('active');
            document.getElementById('login-submit-btn').disabled = true;

            const formData = new FormData();
            formData.append('file', capturedImages['login'], 'front.jpg');

            try {
                const response = await fetch('http://localhost:8080/api/ocr/login', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showMessage('login', result.message, 'success');
                    displayUserData('login', result.user);
                } else {
                    showMessage('login', result.message, 'error');
                }
            } catch (error) {
                showMessage('login', 'Error: ' + error.message, 'error');
            } finally {
                document.getElementById('login-loading').classList.remove('active');
                document.getElementById('login-submit-btn').disabled = false;
            }
        }

        async function registerUser() {
            if (!capturedImages['register-front'] || !capturedImages['register-back']) {
                showMessage('register', 'Please capture both front and back of ID card', 'error');
                return;
            }

            document.getElementById('register-loading').classList.add('active');
            document.getElementById('register-submit-btn').disabled = true;

            const formData = new FormData();
            formData.append('front', capturedImages['register-front'], 'front.jpg');
            formData.append('back', capturedImages['register-back'], 'back.jpg');

            try {
                const response = await fetch('http://localhost:8080/api/ocr/register', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showMessage('register', result.message, 'success');
                    displayUserData('register', result.data);
                } else {
                    showMessage('register', result.message, 'error');
                }
            } catch (error) {
                showMessage('register', 'Error: ' + error.message, 'error');
            } finally {
                document.getElementById('register-loading').classList.remove('active');
                document.getElementById('register-submit-btn').disabled = false;
            }
        }

        function showMessage(type, message, status) {
            const messageEl = document.getElementById(`${type}-message`);
            messageEl.textContent = message;
            messageEl.className = `message ${status}`;
        }

        function displayUserData(type, user) {
            const dataEl = document.getElementById(`${type}-user-data`);
            dataEl.innerHTML = `
                <h3>User Information</h3>
                <div class="user-field"><strong>Name:</strong> ${user.name || 'N/A'}</div>
                <div class="user-field"><strong>Register No:</strong> ${user.registerNumber || 'N/A'}</div>
                <div class="user-field"><strong>Programme:</strong> ${user.programme || 'N/A'}</div>
                <div class="user-field"><strong>Email:</strong> ${user.email || 'N/A'}</div>
                <div class="user-field"><strong>Date of Birth:</strong> ${user.dateOfBirth || 'N/A'}</div>
                <div class="user-field"><strong>Blood Group:</strong> ${user.bloodGroup || 'N/A'}</div>
                <div class="user-field"><strong>Valid From:</strong> ${user.validFrom || 'N/A'}</div>
                <div class="user-field"><strong>Valid To:</strong> ${user.validTo || 'N/A'}</div>
                <div class="user-field"><strong>Verified:</strong> ${user.verified ? 'Yes ‚úÖ' : 'No ‚ùå'}</div>
            `;
            dataEl.classList.add('active');
        }

        function dataURLtoBlob(dataURL) {
            const parts = dataURL.split(',');
            const contentType = parts[0].split(':')[1].split(';')[0];
            const raw = window.atob(parts[1]);
            const rawLength = raw.length;
            const uInt8Array = new Uint8Array(rawLength);

            for (let i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }

            return new Blob([uInt8Array], { type: contentType });
        }
    </script>
</body>
</html>
